<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>像素猫养成</title>
    
    <!-- 引入NES.css复古样式库 -->
    <link href="https://unpkg.com/nes.css@latest/css/nes.min.css" rel="stylesheet" />
    <!-- 引入像素风格字体 (Press Start 2P for English/Numbers, ZCOOL KuaiLe for Chinese) -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <!-- 引入 Tone.js 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
        /* Global styles */
        body {
            font-family: 'ZCOOL KuaiLe', 'Press Start 2P', cursive; /* Prioritize Chinese pixel font, fallback to English pixel font */
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            overflow: hidden;
        }

        /* Game main container */
        .game-container {
            width: 100%;
            max-width: 800px;
            margin: auto;
        }
        
        /* Cat display area */
        #cat-display {
            background-color: #fff;
            border: 4px solid black;
            padding: 2rem;
            margin-bottom: 1rem;
            height: 300px; /* Fixed height for the display area */
            display: flex;
            flex-direction: column; 
            justify-content: center;
            align-items: center;
            text-align: center;
            image-rendering: pixelated; /* Keep pixelated look for any scaled elements */
            white-space: pre; /* Preserve ASCII art formatting */
            font-size: 1.5rem; /* Adjust font size for ASCII art */
            line-height: 1.2; /* Adjust line height for ASCII art */
            overflow: hidden;
            position: relative;
        }

        /* Cat name display */
        #cat-name-display {
            font-size: 1.2rem; 
            margin-bottom: 0.5rem; 
            position: absolute; 
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(255,255,255,0.8); 
            padding: 0.2rem 0.5rem;
            border-radius: 5px;
        }

        /* Cat visual container */
        #cat-visual {
            flex-grow: 1; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px; /* Re-add min-height for ASCII art */
            /* New: Cursor for interaction */
            cursor: grab; /* Default grab cursor, will change on hover */
        }
        /* New: Cursor on hover for petting */
        #cat-visual:hover {
            cursor: pointer; /* Changed to standard pointer for better compatibility */
        }

        /* Ensure the <pre> tag inside #cat-visual displays correctly */
        #cat-visual pre {
            font-family: 'ZCOOL KuaiLe', 'Press Start 2P', cursive; /* Re-apply pixel font */
            font-size: 1.5rem; /* Ensure font size */
            color: black; /* Explicitly set font color */
            padding: 10px; /* Add padding */
            box-sizing: border-box; /* Include padding in dimensions */
            white-space: pre; /* Preserve pre-formatting */
            line-height: 1.2; /* Maintain line height */
        }


        /* Cat status information */
        #cat-status-text {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.8rem;
            text-align: left;
            background: rgba(255,255,255,0.7);
            padding: 5px;
            border-radius: 5px;
        }

        /* Status bars */
        .status-bars {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Progress bars */
        progress[value] {
            width: 100%;
        }

        /* Action buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); 
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-content {
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            background-color: #fff; 
            border: 4px solid black;
        }

        /* Chat window styles */
        #chat-history {
            height: 300px;
            overflow-y: scroll;
            background: #fff;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 4px solid black;
        }

        .message {
            margin-bottom: 0.5rem;
        }

        .user-message {
            text-align: right;
        }

        .cat-message .nes-balloon {
            width: fit-content;
        }
        
        /* Diary styles */
        #diary-entries {
            max-height: 400px;
            overflow-y: auto;
        }
        .diary-entry {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px dashed #ccc;
        }

        /* Alert modal inner styles */
        #alert-dialog {
            background-color: #fff; 
            border: 4px solid black; 
            padding: 1rem; 
        }

        /* Save slot container styles */
        .save-slot {
            margin-bottom: 1.5rem; 
            padding: 1rem;
            text-align: left;
        }
        .save-slot p {
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }
        .save-slot-actions {
            display: flex;
            align-items: center;
            gap: 1rem; 
            flex-wrap: wrap; 
            margin-top: 1rem;
        }
        .save-slot-actions .nes-input {
            flex-grow: 1; 
            min-width: 150px; 
            margin-bottom: 0; 
        }
        .save-slot-actions button {
            flex-shrink: 0; 
        }

        /* New: Music toggle style in settings */
        .settings-music-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem; 
        }
        .settings-music-toggle label {
            margin-bottom: 0; 
        }
    </style>
</head>
<body>

    <div class="game-container">
        <!-- Cat display area -->
        <div id="cat-display" class="nes-container is-dark with-title">
            <!-- Dynamic cat name display -->
            <h3 class="title" id="cat-name-display"></h3> 
            <!-- Cat visual display area - now uses <pre> for ASCII art -->
            <div id="cat-visual">
                <pre id="cat-ascii-art"></pre>
            </div>
            <div id="cat-status-text"></div>
        </div>

        <!-- Status bars -->
        <div class="status-bars">
            <div class="status-item">
                <span>心情: <span id="mood-value"></span></span>
                <progress id="mood-bar" class="nes-progress is-success" value="70" max="100"></progress>
            </div>
            <div class="status-item">
                <span>饱食度: <span id="hunger-value"></span></span>
                <progress id="hunger-bar" class="nes-progress is-warning" value="80" max="100"></progress>
            </div>
            <div class="status-item">
                <span>依恋: <span id="affection-value"></span></span>
                <!-- Affection progress bar color changed to red -->
                <progress id="affection-bar" class="nes-progress is-error" value="0" max="100"></progress> 
            </div>
            <div class="status-item">
                <span>金钱: ¥<span id="money-display">100</span></span>
            </div>
        </div>

        <!-- Action buttons -->
        <div class="action-buttons">
            <button type="button" class="nes-btn is-white" onclick="playClickSound(); openMainModal('chat-modal')">互动</button>
            <button type="button" class="nes-btn is-white" onclick="playClickSound(); openMainModal('shop-modal')">商店</button>
            <button type="button" class="nes-btn is-white" onclick="playClickSound(); openMainModal('outing-modal')">外出</button>
            <button type="button" class="nes-btn is-white" onclick="playClickSound(); toggleHumanForm()">变身</button>
            <button type="button" class="nes-btn is-white" onclick="playClickSound(); openMainModal('diary-modal')">日记</button>
            <button type="button" class="nes-btn is-info" onclick="playClickSound(); openMainModal('settings-modal')">设置</button>
            <!-- Music toggle moved to settings modal -->
        </div>
    </div>

    <!-- Various Modals -->

    <!-- 1. API Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="nes-container is-rounded with-title modal-content">
            <h3 class="title">API 设置</h3>
            <p>密钥将仅保存在您的浏览器本地。</p>
            <div class="nes-field">
                <label for="api-url">API 地址 (Endpoint)</label>
                <input type="text" id="api-url" class="nes-input" placeholder="例如: https://api.openai.com/v1">
            </div>
            <div class="nes-field">
                <label for="api-key">API 密钥 (Key)</label>
                <input type="password" id="api-key" class="nes-input" placeholder="sk-..."></label>
            </div>
            <div class="nes-field" style="margin-top: 1rem;">
                <button type="button" class="nes-btn is-success" onclick="playClickSound(); fetchModels()">获取模型</button>
            </div>
                <div class="nes-field" style="margin-top: 1rem;">
                <label for="api-model-select">选择模型 (Model)</label>
                <div class="nes-select">
                    <select id="api-model-select" class="nes-input" disabled>
                        <option value="" disabled selected>请先获取模型列表</option>
                    </select>
                </div>
            </div>
            <!-- New: Save and Load button area -->
            <div style="margin-top: 2rem;">
                <h4 class="nes-text">游戏存档位</h4>
                <!-- Save Slot 1 -->
                <div class="save-slot nes-container is-rounded">
                    <p>存档位 1: <span id="slot-name-display-1" class="nes-text is-primary">未命名存档</span></p>
                    <p>保存时间: <span id="save-time-display-1">无</span></p>
                    <p>读取时间: <span id="load-time-display-1">无</span></p>
                    <div class="save-slot-actions">
                        <input type="text" id="save-name-input-1" class="nes-input" placeholder="自定义存档名">
                        <button type="button" class="nes-btn" onclick="playClickSound(); manualSaveGame(1)">保存</button>
                        <button type="button" class="nes-btn is-success" onclick="playClickSound(); manualLoadGame(1)">读取</button>
                    </div>
                </div>
                <!-- Save Slot 2 -->
                <div class="save-slot nes-container is-rounded">
                    <p>存档位 2: <span id="slot-name-display-2" class="nes-text is-primary">未命名存档</span></p>
                    <p>保存时间: <span id="save-time-display-2">无</span></p>
                    <p>读取时间: <span id="load-time-display-2">无</span></p>
                    <div class="save-slot-actions">
                        <input type="text" id="save-name-input-2" class="nes-input" placeholder="自定义存档名">
                        <button type="button" class="nes-btn" onclick="playClickSound(); manualSaveGame(2)">保存</button>
                        <button type="button" class="nes-btn is-success" onclick="playClickSound(); manualLoadGame(2)">读取</button>
                    </div>
                </div>
                <!-- Save Slot 3 -->
                <div class="save-slot nes-container is-rounded">
                    <p>存档位 3: <span id="slot-name-display-3" class="nes-text is-primary">未命名存档</span></p>
                    <p>保存时间: <span id="save-time-display-3">无</span></p>
                    <p>读取时间: <span id="load-time-display-3">无</span></p>
                    <div class="save-slot-actions">
                        <input type="text" id="save-name-input-3" class="nes-input" placeholder="自定义存档名">
                        <button type="button" class="nes-btn" onclick="playClickSound(); manualSaveGame(3)">保存</button>
                        <button type="button" class="nes-btn is-success" onclick="playClickSound(); manualLoadGame(3)">读取</button>
                    </div>
                </div>
            </div>
            <!-- New: Music toggle in settings -->
            <div class="nes-field settings-music-toggle">
                <label for="music-toggle-btn-settings">音效:</label>
                <button type="button" id="music-toggle-btn-settings" class="nes-btn" onclick="playClickSound(); toggleBackgroundMusic()">音效: 开</button>
            </div>

            <div style="text-align: right; margin-top: 1rem;">
                <button type="button" class="nes-btn" onclick="playClickSound(); closeAllModals()">取消</button>
                <button type="button" class="nes-btn is-primary" onclick="playClickSound(); saveSettings()">保存</button>
            </div>
        </div>
    </div>

    <!-- 2. Chat Interaction Modal -->
    <div id="chat-modal" class="modal">
        <div class="nes-container is-rounded with-title modal-content">
            <h3 class="title">和小黑聊天</h3>
            <div id="chat-history"></div>
            <div class="nes-field">
                <input type="text" id="chat-input" class="nes-input" placeholder="说点什么...">
            </div>
            <div style="text-align: right; margin-top: 1rem;">
                <button type="button" class="nes-btn" onclick="playClickSound(); closeAllModals()">关闭</button>
                <button type="button" id="chat-send-btn" class="nes-btn is-primary" onclick="playClickSound(); sendChatMessage()">发送</button>
            </div>
        </div>
    </div>
    
    <!-- 3. Shop Modal -->
    <div id="shop-modal" class="modal">
        <div class="nes-container is-rounded with-title modal-content">
            <h3 class="title">猫猫商店</h3>
            <p>你的钱: ¥<span id="shop-money-display">100</span></p>
            <div id="shop-items"></div>
            <div style="text-align: right; margin-top: 1rem;">
                <button type="button" class="nes-btn" onclick="playClickSound(); closeAllModals()">离开</button>
            </div>
        </div>
    </div>
    
    <!-- 4. Outing Modal (formerly Work Modal) -->
    <div id="outing-modal" class="modal">
        <div class="nes-container is-rounded with-title modal-content">
            <h3 class="title">外出中心</h3>
            <p>让小黑出去玩耍和探索吧！</p>
            <div id="outing-options"></div>
            <div style="text-align: right; margin-top: 1rem;">
                <button type="button" class="nes-btn" onclick="playClickSound(); closeAllModals()">算了</button>
            </div>
        </div>
    </div>

    <!-- 5. Diary Modal -->
    <div id="diary-modal" class="modal">
        <div class="nes-container is-rounded with-title modal-content">
            <h3 class="title">小黑的日记</h3>
            <div id="diary-entries">
                <p>日记本是空的...</p>
            </div>
            <div style="text-align: right; margin-top: 1rem;">
                <button type="button" class="nes-btn" onclick="playClickSound(); closeAllModals()">合上</button>
            </div>
        </div>
    </div>
    
    <!-- Alert Message Modal -->
    <div id="alert-modal" class="modal">
        <div class="nes-dialog is-rounded" id="alert-dialog">
            <p class="title" id="alert-title">提示</p>
            <p id="alert-message">这是一条提示信息。</p>
            <menu class="dialog-menu" style="text-align: center;">
                <button class="nes-btn is-primary" onclick="playClickSound(); document.getElementById('alert-modal').style.display = 'none'">好的</button>
            </menu>
        </div>
    </div>

    <!-- New: Initial Setup Modal -->
    <div id="initial-setup-modal" class="modal">
        <div class="nes-container is-rounded with-title modal-content">
            <h3 class="title">欢迎来到像素猫的世界！</h3>
            <p>请给你的猫咪起一个名字吧：</p>
            <div class="nes-field">
                <label for="cat-name-input">猫咪名字</label>
                <input type="text" id="cat-name-input" class="nes-input" placeholder="例如：小黑">
            </div>
            <div style="text-align: right; margin-top: 1rem;">
                <button type="button" class="nes-btn is-primary" onclick="playClickSound(); startNewGame()">开始游戏</button>
            </div>
        </div>
    </div>

<script>
// =================================================================
// Game Core Logic
// =================================================================

// Game state object
let gameState = {};

// Game data definitions
const shopItems = {
    'milk': { name: '普通牛奶', price: 10, hunger: 15, mood: 2 },
    'fish_can': { name: '鱼罐头', price: 30, hunger: 40, mood: 10 },
    'catnip': { name: '猫薄荷', price: 50, hunger: 5, mood: 30 }
};

// Renamed from workOptions to outingOptions
const outingOptions = {
    'perform': { 
        name: '卖艺', 
        duration: { min: 15, max: 30 }, // Minutes
        mood_change: { min: 5, max: 15 }, 
        money_range: { min: 30, max: 80 },
        outcomes: [
            "小黑今天卖艺很成功，收获了好多掌声和鱼干！",
            "小黑在街角表演了一段精彩的猫步，大家都夸它可爱，还收到了不少打赏！",
            "虽然有点害羞，但小黑还是努力表演了，得到了路人的赞赏和一些零花钱。"
        ]
    },
    'explore': { 
        name: '探险', 
        duration: { min: 30, max: 60 }, // Minutes
        mood_change: { min: -10, max: 20 }, 
        money_range: { min: 50, max: 120 }, 
        fail_chance: 0.2,
        success_outcomes: [
            "小黑在后院发现了一个闪闪发光的鹅卵石，看起来很喜欢！",
            "小黑在草丛里找到了几株神秘的草药，闻起来怪怪的，但感觉很有趣！",
            "小黑在探险中发现了一枚旧硬币，还遇到了几只友善的小鸟，度过了愉快的一天。",
            "小黑在屋顶上晒太阳，发现了一片羽毛，玩得不亦乐乎。"
        ],
        fail_outcomes: [
            "小黑外出探险时迷路了，什么也没带回来，还心情低落了。",
            "小黑在探险中不小心踩到了一摊水，狼狈地跑回来了，看起来有点沮丧。",
            "小黑在外面遇到了几只凶猛的狗，吓得赶紧跑回家了，心情不太好。"
        ],
        special_loot_chance: 0.4, // Chance for dead mouse or other special loot
        special_loot_outcomes: [
            "还带回来一只死老鼠...真是哭笑不得。",
            "它还找到了一颗闪闪发光的鹅卵石！",
            "它发现了一株神秘的草药！"
        ]
    }
};

// Cat's ASCII art frames for animation
const catAnimationFrames = {
    // 单一默认坐姿，但表情可变
    defaultPose: {
        normal: String.raw`
　　　　　／＞　　フ
　　　　　| 　o　o |
　 　　　／\` ミ＿_ノ
　　 　 /　　　　　|
　　　 /　　 ヽ　　ﾉ
　 　 │　　　|　|　|
　／￣|　　 |　|　|
　| (￣ヽ＿_ヽ_)__)
　＼二つ
`,
        happy: String.raw`
　　　　　／＞　　フ
　　　　　| 　^　^ |
　 　　　／\` ミ＿_ノ
　　 　 /　　　　　|
　　　 /　　 ヽ　　ﾉ
　 　 │　　　|　|　|
　／￣|　　 |　|　|
　| (￣ヽ＿_ヽ_)__)
　＼二つ
`,
        sad: String.raw`
　　　　　／＞　　フ
　　　　　| 　T　T |
　 　　　／\` ミ＿_ノ
　　 　 /　　　　　|
　　　 /　　 ヽ　　ﾉ
　 　 │　　　|　|　|
　／￣|　　 |　|　|
　| (￣ヽ＿_ヽ_)__)
　＼二つ
`
    },
    // 人类形态现在只显示文字
    humanShy: String.raw`
猫猫很害羞，它躲起来了
`,
    working: String.raw`
  (外出中...)
`
};

// --- Audio Setup (Tone.js) ---
let clickSound;
let isMusicOn = true; // Default music state

// Play a click sound
function playClickSound() {
    if (isMusicOn && clickSound) { 
        clickSound.triggerAttackRelease("C5", "32n"); 
    } else if (isMusicOn && !clickSound) {
        console.warn("playClickSound: clickSound not yet initialized.");
    }
}

// Initialize audio components
function initAudio() {
    // Click Sound Synth - Only click sound is initialized
    clickSound = new Tone.Synth({
        oscillator: {
            type: "sine" 
        },
        envelope: {
            attack: 0.001,
            decay: 0.05,
            sustain: 0,
            release: 0.05
        }
    }).toDestination();

    // Load music state from localStorage (now only affects click sound)
    const savedMusicState = localStorage.getItem('isMusicOn');
    if (savedMusicState !== null) {
        isMusicOn = JSON.parse(savedMusicState);
    }
    updateMusicToggleButton();

    // Start audio context on first user interaction
    document.documentElement.addEventListener('mousedown', Tone.start, { once: true });
    document.documentElement.addEventListener('keydown', Tone.start, { once: true });
    document.documentElement.addEventListener('touchstart', Tone.start, { once: true });

    // No background music to start/stop here.
}


// Toggle background music on/off - now only toggles click sound
function toggleBackgroundMusic() {
    isMusicOn = !isMusicOn;
    localStorage.setItem('isMusicOn', JSON.stringify(isMusicOn)); // Save state
    if (isMusicOn) {
        showAlert('音效', '点击音效已开启！');
    } else {
        showAlert('音效', '点击音效已关闭！');
    }
    updateMusicToggleButton();
}

// Update the text on the music toggle button (now in settings)
function updateMusicToggleButton() {
    const btn = document.getElementById('music-toggle-btn-settings'); // Updated ID for the button in settings
    if (btn) {
        btn.textContent = `音效: ${isMusicOn ? '开' : '关'}`;
    }
}

let catAnimationIntervalId = null; // Global to manage animation loop

/**
 * Renders the current frame of the cat's animation and updates status text.
 */
function renderCatVisual() {
    const catAsciiArtEl = document.getElementById('cat-ascii-art'); // Get the <pre> element
    const catStatusTextEl = document.getElementById('cat-status-text');

    // Ensure gameState and gameState.cat are defined before accessing them
    if (!gameState || !gameState.cat) {
        console.warn("renderCatVisual: gameState or gameState.cat is undefined. Cannot render cat visual.");
        catAsciiArtEl.textContent = "(猫咪加载中...)"; // Placeholder
        catStatusTextEl.textContent = "";
        return;
    }

    let currentArt = "";
    if (gameState.cat.isWorking) { // 'isWorking' now also covers '外出'
        currentArt = catAnimationFrames.working;
    } else if (gameState.cat.isHuman) { // Check if isHuman is true
        currentArt = catAnimationFrames.humanShy; // Display shy message
    } else {
        // Always use 'defaultPose' as the action
        const currentAction = 'defaultPose'; 

        let currentExpression = 'normal';
        // Prioritize hovered state for expression
        if (gameState.cat.isHovered) { // New flag for hover
            currentExpression = 'happy';
        } else if (gameState.cat.mood > 80) {
            currentExpression = 'happy';
        } else if (gameState.cat.mood < 30 || gameState.cat.hunger < 20) {
            currentExpression = 'sad';
        }
        
        // Ensure the selected action and expression exist
        if (catAnimationFrames[currentAction] && catAnimationFrames[currentAction][currentExpression]) {
            currentArt = catAnimationFrames[currentAction][currentExpression];
        } else {
            currentArt = catAnimationFrames.defaultPose.normal; // Fallback to default
            console.warn(`Fallback to defaultPose.normal: Action ${currentAction}, Expression ${currentExpression} not found.`);
        }
    }
    
    catAsciiArtEl.textContent = currentArt;
    
    // Update status text separately based on current game state
    let statusText = "状态: 普通";
    if (gameState.cat.isHuman) {
        statusText = "形态: 人类 (躲藏中)"; // Update status text for human form
    } else if (gameState.cat.isWorking) {
        statusText = "外出中..."; // Updated status text for '外出'
    } else {
        // Cat form animations based on mood and hunger
        if (gameState.cat.mood > 80) {
            statusText = "心情: 愉悦";
        } else if (gameState.cat.mood < 30 || gameState.cat.hunger < 20) {
            statusText = "心情: 低落";
        }
    }
    catStatusTextEl.textContent = statusText + `\n饱食度: ${gameState.cat.hunger}\n心情: ${gameState.cat.mood}\n依恋: ${gameState.cat.affection}`;
}

/**
 * Starts the cat's animation loop. Clears any existing loop and sets a new one.
 * For ASCII art, we don't have multi-frame animations in the same way as pixel art,
 * so this function primarily ensures the correct static ASCII art is displayed.
 */
function startCatAnimationLoop() {
    // For now, ASCII art is static per state, so we just render it once.
    renderCatVisual(); 
}

/**
 * Determines the appropriate animation state for the cat based on game conditions
 * and initiates the animation loop if the state changes.
 */
function setCatAnimationState() {
    // Ensure gameState and gameState.cat are defined
    if (!gameState || !gameState.cat) {
        console.warn("setCatAnimationState: gameState or gameState.cat is undefined. Cannot set animation state.");
        return;
    }

    let newAnimationName = 'defaultPose'; // Always use defaultPose for cat form
    let newExpression = 'normal'; // Default expression

    if (gameState.cat.isWorking) {
        newAnimationName = 'working';
        newExpression = ''; // No expression for working state
    } else if (gameState.cat.isHuman) {
        newAnimationName = 'humanShy'; // Special state for hidden human form
        newExpression = ''; // No expression for human state
    } else {
        // Determine expression based on mood and hunger
        // Prioritize hovered state for expression
        if (gameState.cat.isHovered) { // New flag for hover
            newExpression = 'happy';
        } else if (gameState.cat.mood > 80) {
            newExpression = 'happy';
        } else if (gameState.cat.mood < 30 || gameState.cat.hunger < 20) {
            newExpression = 'sad';
        } else {
            newExpression = 'normal';
        }
    }

    // Check if the overall visual state has changed
    const currentVisualState = `${gameState.cat.currentAnimationName}_${gameState.cat.currentExpression}`;
    const newVisualState = `${newAnimationName}_${newExpression}`;

    if (currentVisualState !== newVisualState) {
        gameState.cat.currentAnimationName = newAnimationName;
        gameState.cat.currentExpression = newExpression; // Store the current expression
        gameState.cat.currentAnimationFrameIndex = 0; 
        startCatAnimationLoop(); // Render the new state
    } else {
        renderCatVisual(); // Just re-render if state is the same (e.g., during gameTick)
    }
}


// --- Game Initialization and Save/Load ---

// Function to get the save key for a given slot
function getSaveKey(slot = 1) { 
    return `pixelCatSave_${slot}`;
}

// Helper to get full slot data (game state + metadata)
function getSaveData(slot) {
    const savedData = localStorage.getItem(getSaveKey(slot));
    return savedData ? JSON.parse(savedData) : null;
}

// Save game function, now accepts custom name
function saveGame(slot = 1, customName = '') { 
    const now = new Date().toLocaleString('zh-CN');
    const saveData = {
        gameData: gameState,
        slotName: customName || `存档 ${now}`, 
        saveTime: now,
        loadTime: getSaveData(slot)?.loadTime || '无' 
    };
    localStorage.setItem(getSaveKey(slot), JSON.stringify(saveData));
}

// Load game function, now updates load time
function loadGame(slot = 1) { 
    const savedSlotData = getSaveData(slot);
    if (savedSlotData) {
        if (savedSlotData.gameData) {
            gameState = savedSlotData.gameData;
        } else {
            gameState = savedSlotData; 
        }
        
        // Ensure new properties exist in loaded gameState for compatibility with old saves
        if (gameState.cat.affection === undefined) gameState.cat.affection = 0;
        if (gameState.lastPlayedTimestamp === undefined) gameState.lastPlayedTimestamp = Date.now();
        if (gameState.lastHungerDecayTimestamp === undefined) gameState.lastHungerDecayTimestamp = Date.now();
        if (gameState.cat.catName === undefined) gameState.cat.catName = '小黑'; 
        // Initialize new animation state properties if not present in old saves
        if (gameState.cat.currentAnimationName === undefined) gameState.cat.currentAnimationName = 'defaultPose'; // Default to defaultPose
        if (gameState.cat.currentExpression === undefined) gameState.cat.currentExpression = 'normal';
        if (gameState.cat.currentAction === undefined) gameState.cat.currentAction = 'defaultPose'; // Ensure action is set
        if (gameState.cat.currentAnimationFrameIndex === undefined) gameState.cat.currentAnimationFrameIndex = 0;
        if (gameState.cat.isHovered === undefined) gameState.cat.isHovered = false; // Initialize new property


        // Update load time in the saved data and re-save
        savedSlotData.loadTime = new Date().toLocaleString('zh-CN');
        localStorage.setItem(getSaveKey(slot), JSON.stringify(savedSlotData));

        // Check if it's a new day (only for the main auto-load slot)
        if (slot === 1) {
            const today = new Date().toISOString().split('T')[0];
            if (gameState.lastLogin && gameState.lastLogin !== today) {
                generateDiaryEntry("新的一天开始了，感觉怎么样？");
                gameState.lastLogin = today;
            } else if (!gameState.lastLogin) { 
                gameState.lastLogin = today;
            }
        }
        return true; 
    }
    return false; 
}

window.onload = function() {
    initAudio(); // Initialize audio first
    // Try to load from slot 1 on initial page load
    if (!loadGame(1)) { 
        initialSetup(); 
    } else {
        updateAllUI(); 
    }
    // Update game state every 5 seconds
    setInterval(gameTick, 1000 * 5);  
    // Send chat message on Enter key press
    document.getElementById('chat-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });

    // New: Mouse hover interaction for cat visual
    const catVisualEl = document.getElementById('cat-visual');
    catVisualEl.addEventListener('mouseenter', function() {
        if (!gameState.cat.isWorking && !gameState.cat.isHuman) { // Only change expression if not working or human
            gameState.cat.isHovered = true; // Set hover flag
            setCatAnimationState(); // Update animation to happy
            playClickSound(); // Play sound on hover
        }
    });

    catVisualEl.addEventListener('mouseleave', function() {
        if (!gameState.cat.isWorking && !gameState.cat.isHuman) { // Only revert expression if not working or human
            gameState.cat.isHovered = false; // Clear hover flag
            setCatAnimationState(); // Revert animation based on mood
        }
    });
};

function gameTick() {
    // Ensure gameState and gameState.cat are defined before proceeding
    if (!gameState || !gameState.cat) {
        console.warn("gameTick: gameState or gameState.cat is undefined. Skipping gameTick.");
        return;
    }

    // State decreases slowly over time
    if (gameState.cat.isWorking) return;

    const now = Date.now(); 

    // --- Hunger decay based on real time ---
    if (gameState.lastHungerDecayTimestamp === undefined || gameState.lastHungerDecayTimestamp === null) {
        gameState.lastHungerDecayTimestamp = now;
    }
    
    const timeElapsedSinceLastHungerDecay = now - gameState.lastHungerDecayTimestamp; 
    const hoursPassedForHunger = timeElapsedSinceLastHungerDecay / (1000 * 60 * 60); 

    const hungerDecayRatePerHour = 10; 
    const hungerDecrease = Math.floor(hoursPassedForHunger * hungerDecayRatePerHour);

    if (hungerDecrease > 0) {
        gameState.cat.hunger = Math.max(0, gameState.cat.hunger - hungerDecrease);
        gameState.lastHungerDecayTimestamp = now; 
    }

    // --- Affection increase based on real time ---
    if (gameState.lastPlayedTimestamp === undefined || gameState.lastPlayedTimestamp === null) {
        gameState.lastPlayedTimestamp = now;
    }

    const timeElapsedSinceLastPlayed = now - gameState.lastPlayedTimestamp; 
    const hoursPassedForAffection = timeElapsedSinceLastPlayed / (1000 * 60 * 60); 

    if (hoursPassedForAffection >= 1) { 
        const affectionIncrease = Math.floor(hoursPassedForAffection);
        gameState.cat.affection = Math.min(100, gameState.cat.affection + affectionIncrease);
        if (affectionIncrease > 0) {
            generateDiaryEntry(`感觉和${gameState.cat.catName}更亲近了，依恋度增加了${affectionIncrease}点。`);
        }
    }
    gameState.lastPlayedTimestamp = now; 

    setCatAnimationState(); 
    updateAllUI(); 
    saveGame(1, getSaveData(1)?.slotName); 
}

function getDefaultGameState() {
    return {
        money: 100,
        cat: {
            catName: '', 
            mood: 70, 
            hunger: 80, 
            affection: 10, 
            isHuman: false,
            isWorking: false, // Now indicates if cat is "out"
            isHovered: false, // New: flag for mouse hover state
            currentAnimationName: 'defaultPose', 
            currentAction: 'defaultPose', 
            currentExpression: 'normal', 
            currentAnimationFrameIndex: 0 
        },
        inventory: {
            'milk': 1,
            'fish_can': 0,
            'catnip': 0
        },
        diaryEntries: [],
        lastLogin: new Date().toISOString().split('T')[0], 
        lastPlayedTimestamp: Date.now(), 
        lastHungerDecayTimestamp: Date.now() 
    };
}


function toggleHumanForm() {
  if (gameState.cat.mood >= 80) {
    gameState.cat.isHuman = !gameState.cat.isHuman;
    // If transforming to human, set animation to humanShy
    if (gameState.cat.isHuman) {
        generateDiaryEntry("今天决定变成人玩一下。");
        showAlert("变身成功", "猫猫很害羞，它躲起来了。");
    } else {
        // If transforming back to cat, revert to a cat action
        generateDiaryEntry("做人好累，还是当猫好。");
        showAlert("变身成功", `${gameState.cat.catName}恢复了猫咪形态。`);
    }
    setCatAnimationState(); 
    updateAllUI();
    saveGame(1, getSaveData(1)?.slotName); 
  } else {
    showAlert('条件不足', `${gameState.cat.catName}心情不好，不想变成人。`);
  }
}

// --- Manual Save/Load Functions ---
function manualSaveGame(slot) {
    const customNameInput = document.getElementById(`save-name-input-${slot}`);
    const customName = customNameInput.value.trim();
    saveGame(slot, customName); 
    updateSettingsUI(); 
    showAlert('游戏已保存', `小黑的最新状态已记录在存档位 ${slot} (${customName || '未命名存档'})！`);
}

function manualLoadGame(slot) {
    const savedSlotData = getSaveData(slot);
    if (!savedSlotData) {
        showAlert('没有存档', `存档位 ${slot} 没有找到可读取的游戏存档。`);
        return;
    }

    const confirmLoad = (title, message, onConfirm) => {
        const confirmModal = document.getElementById('alert-modal'); 
        document.getElementById('alert-title').textContent = title;
        document.getElementById('alert-message').textContent = message;
        
        const menu = confirmModal.querySelector('.dialog-menu');
        menu.innerHTML = ''; 
        
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'nes-btn is-primary';
        confirmBtn.textContent = '确认';
        confirmBtn.onclick = () => {
            confirmModal.style.display = 'none';
            onConfirm();
            showAlert('操作完成', '已完成操作。'); 
        };
        menu.appendChild(confirmBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'nes-btn';
        cancelBtn.textContent = '取消';
        cancelBtn.onclick = () => {
            confirmModal.style.display = 'none';
            showAlert('操作取消', '已取消读取存档。'); 
        };
        menu.appendChild(cancelBtn);

        confirmModal.style.display = 'flex';
    };

    confirmLoad('确认读取？', `读取存档位 ${slot} (${savedSlotData.slotName}) 将覆盖当前游戏进度，确定要继续吗？`, () => {
        if (loadGame(slot)) { 
            setCatAnimationState(); 
            updateAllUI(); 
            closeAllModals(); 
        } else {
            showAlert('读取失败', `无法读取存档位 ${slot}，请确保有存档存在。`);
        }
    });
}


// --- UI Updates ---

function updateAllUI() {
    // Cat Name Display
    document.getElementById('cat-name-display').textContent = gameState.cat.catName;

    // Status bars
    document.getElementById('mood-bar').value = gameState.cat.mood;
    document.getElementById('mood-value').textContent = gameState.cat.mood; 
    
    document.getElementById('hunger-bar').value = gameState.cat.hunger;
    document.getElementById('hunger-value').textContent = gameState.cat.hunger; 
    
    const affectionBar = document.getElementById('affection-bar');
    affectionBar.value = gameState.cat.affection;
    document.getElementById('affection-value').textContent = gameState.cat.affection; 
    affectionBar.classList.remove('is-primary', 'is-success', 'is-warning'); 
    affectionBar.classList.add('is-error'); 

    document.getElementById('money-display').textContent = gameState.money;
    document.getElementById('shop-money-display').textContent = gameState.money;

    setCatAnimationState(); 
    
    // Modals
    renderShopItems();
    renderOutingOptions(); // Updated function name
    renderDiary();
}


// --- Modal Management ---

// Function to open a main modal, ensuring others are closed.
function openMainModal(modalId) {
    closeAllModals();
    showModal(modalId);
}

// showModal now handles updating settings UI specifically
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        if (modalId === 'settings-modal') {
            document.getElementById('api-url').value = localStorage.getItem('apiUrl') || '';
            document.getElementById('api-key').value = localStorage.getItem('apiKey') || '';
            const selectEl = document.getElementById('api-model-select');
            const savedModel = localStorage.getItem('apiModel');
            if (savedModel) {
                selectEl.innerHTML = `<option value="${savedModel}" selected>${savedModel}</option>`;
                selectEl.disabled = false;
            } else {
                selectEl.innerHTML = '<option value="" disabled selected>请先获取模型列表</option>';
                selectEl.disabled = true;
            }
            updateSettingsUI(); 
            updateMusicToggleButton(); 
        }
        modal.style.display = 'flex';
    }
}

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
}

// showAlert now shows on top of other modals and ensures a single '好的' button
function showAlert(title, message) {
    document.getElementById('alert-title').textContent = title;
    document.getElementById('alert-message').textContent = message;
    
    const menu = document.getElementById('alert-modal').querySelector('.dialog-menu');
    menu.innerHTML = ''; 
    const okBtn = document.createElement('button');
    okBtn.className = 'nes-btn is-primary';
    okBtn.textContent = '好的';
    okBtn.onclick = () => {
        document.getElementById('alert-modal').style.display = 'none';
    };
    menu.appendChild(okBtn);

    document.getElementById('alert-modal').style.display = 'flex';
}

// Function to update the UI for save/load slots in settings
function updateSettingsUI() {
    for (let i = 1; i <= 3; i++) {
        const slotData = getSaveData(i);
        const nameDisplay = document.getElementById(`slot-name-display-${i}`);
        const saveTimeDisplay = document.getElementById(`save-time-display-${i}`);
        const loadTimeDisplay = document.getElementById(`load-time-display-${i}`);
        const nameInput = document.getElementById(`save-name-input-${i}`);

        if (slotData) {
            nameDisplay.textContent = slotData.slotName;
            saveTimeDisplay.textContent = slotData.saveTime;
            loadTimeDisplay.textContent = slotData.loadTime;
            nameInput.value = slotData.slotName; 
        } else {
            nameDisplay.textContent = '未命名存档';
            saveTimeDisplay.textContent = '无';
            loadTimeDisplay.textContent = '无';
            nameInput.value = ''; 
        }
    }
}

// --- Initial Setup for New Game ---
function initialSetup() {
    closeAllModals();
    document.getElementById('initial-setup-modal').style.display = 'flex';
}

function startNewGame() {
    const catNameInput = document.getElementById('cat-name-input');
    const catName = catNameInput.value.trim();

    if (!catName) {
        showAlert('提示', '请给你的猫咪起一个名字！');
        return;
    }

    gameState = getDefaultGameState(); 
    gameState.cat.catName = catName; 
    gameState.lastPlayedTimestamp = Date.now(); 
    gameState.lastHungerDecayTimestamp = Date.now(); 

    saveGame(1, catName); 
    setCatAnimationState(); 
    updateAllUI();
    closeAllModals();
    showAlert('欢迎', `欢迎，你的猫咪 ${catName} 准备好和你一起玩耍了！`);
}

// --- API Settings ---

async function fetchModels() {
    const apiUrl = document.getElementById('api-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();
    const selectEl = document.getElementById('api-model-select');

    if (!apiUrl || !apiKey) {
        showAlert('信息不完整', '请输入API地址和密钥以获取模型列表。');
        return;
    }

    selectEl.innerHTML = '<option>正在获取...</option>';
    selectEl.disabled = true;

    try {
        const response = await fetch(`${apiUrl}/models`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API请求失败，状态码: ${response.status} - ${errorData.error?.message || '未知错误'}`);
        }
        const data = await response.json();
        const models = data.data;
        if (!models || models.length === 0) throw new Error('未找到可用模型。');

        selectEl.innerHTML = '';
        selectEl.disabled = false;
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.id;
            selectEl.appendChild(option);
        });
        
        const savedModel = localStorage.getItem('apiModel');
        if (savedModel) selectEl.value = savedModel;

    } catch (error) {
        console.error("获取模型列表失败:", error);
        showAlert('获取失败', `无法获取模型列表: ${error.message}`);
        selectEl.innerHTML = '<option value="" disabled selected>获取模型失败</option>';
        selectEl.disabled = true;
    }
}

function saveSettings() {
    const apiUrl = document.getElementById('api-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();
    const apiModelSelect = document.getElementById('api-model-select');
    const apiModel = apiModelSelect.value;

    if (apiUrl && apiKey && apiModel) {
        localStorage.setItem('apiUrl', apiUrl);
        localStorage.setItem('apiKey', apiKey);
        localStorage.setItem('apiModel', apiModel);
        showAlert('成功', 'API设置已保存！');
        closeAllModals();
    } else {
        showAlert('错误', '请填写API地址、密钥，并选择一个模型！');
    }
}

// --- Core API Call ---

async function callGenerativeAPI(prompt, systemPrompt) {
    const apiUrl = localStorage.getItem('apiUrl');
    const apiKey = localStorage.getItem('apiKey');
    const apiModel = localStorage.getItem('apiModel');

    if (!apiUrl || !apiKey || !apiModel) {
        showAlert('API未配置', '请先在“设置”中配置您的API信息！');
        return null;
    }

    const endpoint = `${apiUrl}/chat/completions`;
    
    // Build context for the system prompt
    let context = ``;
    context += `猫咪当前状态：心情 ${gameState.cat.mood}，饱食度 ${gameState.cat.hunger}，依恋 ${gameState.cat.affection}。`;
    if (gameState.cat.isHuman) {
        context += `猫咪目前处于人类形态（躲藏中）。`;
    } else if (gameState.cat.isWorking) {
        context += `猫咪目前正在外出中。`;
    }

    // Add recent diary entries for more context
    if (gameState.diaryEntries.length > 0) {
        const recentEntries = gameState.diaryEntries.slice(-3).map(entry => `${entry.date}: ${entry.content}`).join('\n');
        context += `\n最近日记条目：\n${recentEntries}`;
    }

    const fullSystemPrompt = `你是一只名叫'${gameState.cat.catName}'的像素黑猫，性格有点傲娇、独立，但内心很在乎你的主人。你的回答必须非常简短、符合猫的身份，并结合以下上下文信息：\n${context}\n请根据主人的话给出回应。`;


    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: apiModel,
                messages: [
                    { role: "system", content: systemPrompt || fullSystemPrompt },
                    { role: "user", content: prompt }
                ],
                max_tokens: 100
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error('API Error:', errorData);
            throw new Error(`API 请求失败: ${response.status} - ${errorData.error?.message || '未知错误'}`);
        }

        const data = await response.json();
        return data.choices[0].message.content;

    } catch (error) {
        console.error("API调用出错:", error);
        showAlert('API错误', `API调用出错: ${error.message}`);
        return "（小黑好像累了，说不出话来...）";
    }
}


// --- Chat Interaction ---

function addMessageToChat(sender, text) {
    const chatHistory = document.getElementById('chat-history');
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    
    if (sender === 'user') {
        messageDiv.classList.add('user-message');
        messageDiv.innerHTML = `<div class="nes-balloon from-right">${text}</div>`;
    } else { // cat
        messageDiv.classList.add('cat-message');
        messageDiv.innerHTML = `<div class="nes-balloon from-left">${text}</div>`;
    }
    chatHistory.appendChild(messageDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight; 
}

// Added loading state and better error handling for chat
async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const sendButton = document.getElementById('chat-send-btn');
    const userInput = input.value.trim();
    if (!userInput || sendButton.disabled) return;

    // Disable inputs to prevent multiple sends
    input.disabled = true;
    sendButton.disabled = true;
    sendButton.textContent = '发送中...';

    addMessageToChat('user', userInput);
    input.value = '';
    addMessageToChat('cat', '...'); 

    try {
        const catResponse = await callGenerativeAPI(userInput);
        
        const messages = document.getElementById('chat-history').children;
        messages[messages.length - 1].remove(); 
        
        if (catResponse) {
            addMessageToChat('cat', catResponse);
            
            // --- Mood feedback based on user input ---
            const complimentKeywords = ['可爱', '棒', '喜欢', '真棒', '厉害', '好乖', '摸摸', '抱抱', '亲亲'];
            const userCompliment = complimentKeywords.some(keyword => userInput.includes(keyword));
            if (userCompliment) {
                gameState.cat.mood = Math.min(100, gameState.cat.mood + Math.floor(Math.random() * 10) + 10); // +10 to +19 mood
                generateDiaryEntry(`主人夸我了，心情真好！`);
            } else {
                gameState.cat.mood = Math.min(100, gameState.cat.mood + Math.floor(Math.random() * 5)); // Small mood increase for general interaction
            }

            // --- Mood feedback based on cat's API response ---
            const positiveCatKeywords = ['开心', '喜欢', '好', '喵', '舒服', '高兴'];
            const negativeCatKeywords = ['累', '不开心', '哼', '困', '烦'];
            
            const catResponseLower = catResponse.toLowerCase();
            if (positiveCatKeywords.some(keyword => catResponseLower.includes(keyword))) {
                gameState.cat.mood = Math.min(100, gameState.cat.mood + Math.floor(Math.random() * 3) + 2); // +2 to +4 mood
            } else if (negativeCatKeywords.some(keyword => catResponseLower.includes(keyword))) {
                gameState.cat.mood = Math.max(0, gameState.cat.mood - Math.floor(Math.random() * 3) - 2); // -2 to -4 mood
            }

            if (Math.random() < 0.1) {
                gameState.cat.isHuman = !gameState.cat.isHuman;
                generateDiaryEntry(gameState.cat.isHuman ? "不知道为什么，突然想变成人的样子看看。" : "还是做猫舒服。");
            }
        }
        setCatAnimationState(); 
        updateAllUI();
        saveGame(1, getSaveData(1)?.slotName); 
    } catch (error) {
        console.error("Chat failed:", error);
    } finally {
        input.disabled = false;
        sendButton.disabled = false;
        sendButton.textContent = '发送';
    }
}

// --- Shop Logic ---

function renderShopItems() {
    const container = document.getElementById('shop-items');
    container.innerHTML = '';
    for (const id in shopItems) {
        const item = shopItems[id];
        const itemDiv = document.createElement('div');
        itemDiv.className = 'nes-container is-rounded';
        itemDiv.style.marginBottom = '1rem';
        itemDiv.innerHTML = `
            <p>${item.name} - ¥${item.price}</p>
            <p>饱食+${item.hunger}, 心情+${item.mood}</p>
            <button class="nes-btn is-success" onclick="playClickSound(); buyItem('${id}')">购买</button>
            <button class="nes-btn is-primary" onclick="playClickSound(); useItem('${id}')" ${gameState.inventory[id] > 0 ? '' : 'disabled'}>
                使用 (库存: ${gameState.inventory[id] || 0})
            </button>
        `;
        container.appendChild(itemDiv);
    }
}

function buyItem(itemId) {
    const item = shopItems[itemId];
    if (gameState.money >= item.price) {
        gameState.money -= item.price;
        gameState.inventory[itemId]++;
        showAlert('购买成功', `你购买了 ${item.name}!`);
        setCatAnimationState(); 
        updateAllUI();
        saveGame(1, getSaveData(1)?.slotName); 
    } else {
        showAlert('没钱了', '你的钱不够哦！');
    }
}

function useItem(itemId) {
    if (gameState.inventory[itemId] > 0) {
        const item = shopItems[itemId];
        gameState.inventory[itemId]--;
        gameState.cat.hunger = Math.min(100, gameState.cat.hunger + item.hunger);
        gameState.cat.mood = Math.min(100, gameState.cat.mood + item.mood);
        showAlert('喂食成功', `${gameState.cat.catName}吃掉了 ${item.name}。`);
        setCatAnimationState(); 
        updateAllUI();
        saveGame(1, getSaveData(1)?.slotName); 
    }
}

// --- Outing Logic (formerly Work Logic) ---

function renderOutingOptions() {
    const container = document.getElementById('outing-options'); // Updated ID
    container.innerHTML = ''; 
    for (const id in outingOptions) { // Using outingOptions
        const outing = outingOptions[id];
        // Display duration in minutes
        const durationText = `${outing.duration.min}-${outing.duration.max}分钟`; 
        const outingDiv = document.createElement('div');
        outingDiv.className = 'nes-container is-rounded';
        outingDiv.style.marginBottom = '1rem';
        outingDiv.innerHTML = `
            <p>${outing.name}</p>
            <p>时长: ${durationText}</p>
            <button class="nes-btn is-white" onclick="playClickSound(); startOuting('${id}')" ${gameState.cat.isWorking ? 'disabled' : ''}>
                ${gameState.cat.isWorking ? '外出中...' : '去外出'}
            </button>
        `;
        container.appendChild(outingDiv);
    }
}

function startOuting(outingId) { // Renamed from startWork
    if (gameState.cat.isWorking) return;
    
    const outing = outingOptions[outingId];
    gameState.cat.isWorking = true;
    closeAllModals();

    // Randomize actual duration within the specified range (in seconds)
    const actualDurationSeconds = (Math.floor(Math.random() * (outing.duration.max - outing.duration.min + 1)) + outing.duration.min) * 60; // Convert minutes to seconds

    showAlert('开始外出', `${gameState.cat.catName}去${outing.name}了，预计${Math.round(actualDurationSeconds / 60)}分钟后回来。`);
    setCatAnimationState(); 
    updateAllUI();

    setTimeout(() => {
        gameState.cat.isWorking = false; // End working state

        let outcomeMessage = "";
        let moneyGained = 0;
        let moodChange = 0;
        let affectionChange = 0;

        // Handle failure chance first for 'explore'
        if (outingId === 'explore' && outing.fail_chance && Math.random() < outing.fail_chance) {
            outcomeMessage = outing.fail_outcomes[Math.floor(Math.random() * outing.fail_outcomes.length)];
            moodChange = -20; // Significant mood drop for failure
        } else {
            // General mood and money from outing
            moodChange = Math.floor(Math.random() * (outing.mood_change.max - outing.mood_change.min + 1)) + outing.mood_change.min;
            moneyGained = Math.floor(Math.random() * (outing.money_range.max - outing.money_range.min + 1)) + outing.money_range.min;

            gameState.money += moneyGained;
            gameState.cat.mood = Math.min(100, Math.max(0, gameState.cat.mood + moodChange));
            
            // Pick a success outcome message
            if (outingId === 'perform') {
                outcomeMessage = outing.outcomes[Math.floor(Math.random() * outing.outcomes.length)];
                affectionChange = 3; // Small affection gain for performing
            } else if (outingId === 'explore') {
                outcomeMessage = outing.success_outcomes[Math.floor(Math.random() * outing.success_outcomes.length)];
                affectionChange = 5; // Good affection gain for successful exploration
                // Special loot chance for 'explore'
                if (outing.special_loot_chance && Math.random() < outing.special_loot_chance) {
                    const specialLootMsg = outing.special_loot_outcomes[Math.floor(Math.random() * outing.special_loot_outcomes.length)];
                    outcomeMessage += specialLootMsg;
                    // Adjust stats based on specific loot (simplified for now)
                    if (specialLootMsg.includes("死老鼠")) {
                        moodChange = Math.min(moodChange + 5, 10); 
                    } else if (specialLootMsg.includes("鹅卵石")) {
                        affectionChange += 5;
                    } else if (specialLootMsg.includes("草药")) {
                        moodChange = Math.min(moodChange + 10, 20); 
                    }
                }
            }
        }
        
        gameState.cat.affection = Math.min(100, Math.max(0, gameState.cat.affection + affectionChange));

        showAlert('外出归来', outcomeMessage);
        generateDiaryEntry(outcomeMessage); // Use the final outcome message for diary

        setCatAnimationState(); 
        updateAllUI();
        saveGame(1, getSaveData(1)?.slotName); 
    }, actualDurationSeconds * 1000); // setTimeout expects milliseconds
}


// --- Diary Logic ---
function renderDiary() {
    const container = document.getElementById('diary-entries');
    if (gameState.diaryEntries.length === 0) {
        container.innerHTML = '<p>日记本是空的...</p>';
        return;
    }
    
    container.innerHTML = '';
    // Display from new to old
    [...gameState.diaryEntries].reverse().forEach(entry => {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'diary-entry';
        entryDiv.innerHTML = `
            <p><strong>${entry.date}</strong></p>
            <p>${entry.content}</p>
        `;
        container.appendChild(entryDiv);
    });
}

async function generateDiaryEntry(eventDescription) {
    // This function still uses API, but the outing outcomes are fixed.
    // If you want to remove API completely, you can just push eventDescription directly.
    const prompt = `基于以下事件，以一只名叫'${gameState.cat.catName}'的傲娇黑猫的口吻，写一篇非常简短的日记（不要超过50个字）。事件：'${eventDescription}'`;
    const systemPrompt = `你是一只名叫'${gameState.cat.catName}'的像素黑猫，正在写自己的私密日记。语气要自然、简短、符合猫的性格。不要有任何多余的开头或结尾，直接写日记内容。`;
    const diaryContent = await callGenerativeAPI(prompt, systemPrompt);

    if (diaryContent && !diaryContent.includes("说不出话来")) {
        gameState.diaryEntries.push({
            date: new Date().toLocaleString('zh-CN'),
            content: diaryContent
        });
        saveGame(1, getSaveData(1)?.slotName); 
        renderDiary(); 
    } else {
        // Fallback if API call fails or is not desired for diary
        gameState.diaryEntries.push({
            date: new Date().toLocaleString('zh-CN'),
            content: `【日记】${eventDescription}` // Use raw event description as fallback
        });
        saveGame(1, getSaveData(1)?.slotName); 
        renderDiary(); 
    }
}

</script>
</body>
</html>
